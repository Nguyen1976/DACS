generator client {
  provider = "prisma-client-js"
  output   = "../../node_modules/.prisma/client"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  email String @unique
  username String @unique
  fullName String
  password String
  avatar String?
  bio String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Friendship {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  friendId String @db.ObjectId
  createdAt DateTime @default(now())
}

enum Status {
  PENDING
  REJECTED
  ACCEPTED
}

model friendRequest {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  fromUserId String @db.ObjectId
  toUserId String @db.ObjectId
  status Status @default(PENDING)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum NotificationType {
  FRIEND_REQUEST
  NORMAL_NOTIFICATION
}
//thông báo cho việc là user đã đồng ý kết bạn hay chưa
model notification {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId//người nhận thông báo
  message String
  isRead Boolean @default(false)
  type String //friend_request, normal_notification
  friendRequestId String? @db.ObjectId //nếu là thông báo kết bạn thì có id của friendRequest
  createdAt DateTime @default(now())
}

enum conversationType {
  DIRECT
  GROUP
}

enum participantRole {
  OWNER
  ADMIN
  MEMBER
}

enum messageType {
  TEXT
  IMAGE
  VIDEO
  FILE
}

enum mediaType {
  IMAGE
  VIDEO
  FILE
}

enum mediaScanStatus {
  PENDING
  SAFE
  QUARANTINED
  FAILED
}

model conversation {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  type conversationType @default(DIRECT)

  //trong trường hợp là cuộc trò chuyện cá nhận thì 2 thằng này là null
  groupName String?
  groupNameLower String?

  groupAvatar String?

  members     conversationMember[]
  messages    message[]

  lastMessageId String? @db.ObjectId
  lastMessageAt DateTime?
  lastMessageType messageType?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  groupNameSearch String?

  @@index([type, groupNameSearch, updatedAt])
  @@index([lastMessageAt])
}

model conversationMember {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  conversationId String @db.ObjectId
  
  userId String @db.ObjectId

  username String?
  fullName String?
  avatar String? 

  role participantRole @default(MEMBER) //nếu là nhóm thì có vai trò như admin hay member

  lastReadMessageId   String? @db.ObjectId
  lastReadAt          DateTime?
  lastDeliveredAt     DateTime?

  joinedAt DateTime @default(now())

  conversation conversation @relation(fields: [conversationId], references: [id])
  
  sentMessages message[] @relation("SenderMessages")

  lastMessageAt DateTime?

  @@unique([conversationId, userId])
  @@index([userId, lastMessageAt])
  @@index([username])
  @@index([conversationId, lastReadAt])
}

enum deleteType {
  SELF
  GLOBAL
}
model message {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  conversationId String @db.ObjectId
  senderId String @db.ObjectId
  type messageType @default(TEXT)
  content String?
  clientMessageId String
  replyToMessageId String? @db.ObjectId

  isDeleted Boolean @default(false)
  deletedAt DateTime?
  deletedByUserId String? @db.ObjectId
  deleteType deleteType?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  conversation conversation @relation(fields: [conversationId], references: [id])
  
  senderMember conversationMember @relation("SenderMessages", fields: [conversationId, senderId], references: [conversationId, userId])

  replyTo message? @relation("MessageReply", fields: [replyToMessageId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies message[] @relation("MessageReply")

  medias messageMedia[]

  @@unique([conversationId, senderId, clientMessageId])
  @@index([conversationId, createdAt, id])
  @@index([conversationId, senderId, createdAt])
  @@index([replyToMessageId])
}

model messageMedia {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  messageId String @db.ObjectId
  mediaType mediaType

  objectKey String @unique
  url String
  mimeType String
  size BigInt

  width Int?
  height Int?
  duration Float?

  checksum String?
  thumbnailKey String?
  thumbnailUrl String?

  scanStatus mediaScanStatus @default(PENDING)
  scanProvider String?
  scanDetail String?

  sortOrder Int @default(0)
  createdAt DateTime @default(now())

  message message @relation(fields: [messageId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([messageId, sortOrder])
}
